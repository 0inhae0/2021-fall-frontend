# 12월 스터디

## 시작하기에 앞서

지난 학기 인프 수업의 텀 프로젝트를 진행했을 때 마주했던 에러에 대해서 정리해보려고 합니다. 프로젝트를 진행할 때는 일단 에러를 없애는 데 급했어서 표면적으로만 해결하다보니 이렇게 해결한 에러가 나중에 발목을 잡는다는 것을 경험하고는 에러의 근본적인 원인을 이해하고 해결하는 것의 중요성을 알게 되었습니다. 대표적으로 CORS 에러, 인코딩 변환 문제, 비동기 처리로 인한 에러가 있었는데 비교적 간단하게 해결했던 인코딩 문제에 대해 알아보고자 합니다.

## 문제가 발생한 배경

php로 주식 웹 사이트를 크롤링하던 중이었습니다. 종목명을 배열에 담아 `var_dump` 로 출력해보니 다음과 같이 출력되었습니다.

```php
array(152) { [0]=> string(0) "" [1]=> string(0) "" [2]=> string(0) "" [3]=> string(0) "" [4]=> string(0) "" [5]=> string(0) "" [6]=> string(0) "" [7]=> string(0) "" [8]=> string(0) "" ...(생략) }
```

종목이 총 152개라 `array(152)` 를 통해 배열이 제대로 생성되긴 했지만, 배열 안을 살펴보면 `string(0) ""` 으로 종목명이 아예 출력되지 않는 문제가 발생한 것을 알 수 있었습니다. 처음에는 작성한 코드에 문제가 있거나 어쩌면 웹 사이트에서 크롤링을 막아놓은 것은 아닐지 의심해보았습니다. 그러다가 Chorme 개발자 도구로 웹사이트의 html 문서 전체를 읽어보기 시작했고 *euc-kr*라고 적힌 부분을 통해 인코딩 문제일 수도 있겠다는 생각을 하게 되었습니다.

## 인코딩에 대해 알아보자

인코딩이란 문자나 기호를 컴퓨터로 처리하기 위해 약속된 규칙에 따라 코드화하고 압축하는 것을 의미합니다. 초기의 컴퓨터는 수치 연산을 하기 위해 만들어진 계산기였기 때문에 문자를 표현할 일이 없었지만, 이후 문자를 표현해야 하는 요구가 생기면서 표준문자인코딩 체계인 ASCII가 만들어지게 되었습니다.

ASCII란 *American Standard Code for Information Interchange*의 줄임말로 미국에서 제정되었기 때문에 영어나 유럽의 언어를 표현하는 데에는 문제가 없었습니다. 그러나 ASCII는 7비트 인코딩 방식을 사용했기 때문에 128개의 부호만을 표현할 수 있었고 한글이나 중국어와 같은 다양한 언어를 표현하는 것이 불가능했습니다. 이 문제를 해결하기 위해 전 세계의 문자를 일관되게 표현할 수 있도록 설계된 산업 표준인 유니코드가 등장하게 됩니다. 유니코드도 ASCII와 마찬가지로 모든 문자에 코드값을 부여합니다.

## EUC-KR vs UTF-8

제가 난항을 겪었던 부분입니다. EUC-KR로 인코딩된 문서를 UTF-8로 표현하려다 발생한 문제였는데 EUC-KR과 UTF-8은 어떤 차이가 있는지 알아봅시다.

### EUC-KR

EUC는 *Extend Unix Code*의 약자로 유닉스에서 영어를 제외한 문자를 표시하기 위한 확장 부호를 의미하며 EUC-KR은 2바이트로 한글을 표현하는 완성형 인코딩 방식입니다. 완성형 인코딩 방식이란 문자를 하나의 완성된 글자로 인식하여 글자에 대응하는 코드가 이미 존재하는 방식입니다. EUC-KR은 사용빈도가 높은 글자를 추려서 2,350자의 한글만을 표현할 수 있기 때문에 표현하지 못하는 한글이 존재합니다. 따라서 만약 ‘꽭’이라는 글자에 대응하는 문자표가 존재하지 않는다면 깨져서 보이게 됩니다.

### UTF-8

최근에 표준으로 가장 많이 사용되고 있는 인코딩 방식인 UTF-8 방식은 EUC-KR과 달리 유니코드를 인코딩하는 방식 중 하나입니다. UTF는 *Unicode Transform Format*의 약자이며 뒤의 8은 인코딩하는 방식을 나타내는데 8비트 단위로 인코딩한다는 의미입니다. 같은 유니코드 표를 어떻게 표현하는지에 따라 UTF-8, UTF-16, UTF-32 등으로 나눌 수 있습니다. 이 중 비교했을 때 UTF-8 방식이 가장 호환성이 좋습니다.
또한 UTF-8은 가변 길이 문자 인코딩 방식으로 EUC-KR과 다르게 글자마다 표현하는 바이트 길이가 다릅니다. 기존 ASCII로 표현 가능한 문자는 1바이트로 표현하고 1바이트로 표현 불가능한 문자들은 2~4바이트를 사용하여 표현합니다. 따라서 ASCII 방식과 완벽하게 호환 가능하다는 장점이 있습니다.

## 문제를 해결해보자

원하는 종목명이 배열에 담기지 않았던 것은 크롤링하려는 문서가 EUC-KR로 인코딩되어 있었는데 UTF-8로 표현하려다가 생긴 문제였습니다. UTF-8이나 EUC-KR같은 서로 다른 문자 인코딩 방식은 문자가 깨지는 현상을 일으키기 때문입니다. 따라서 적혀있는 인코딩을 다른 방식으로 읽어왔습니다.

```php
$html =  mb_convert_encoding($html, 'UTF-8', mb_detect_encoding($html, 'EUC-KR', true));
```

위와 같이 적혀있는 EUC-KR 방식의 인코딩을 UTF-8 방식으로 읽어옴으로써 문제를 해결할 수 있었습니다.

```php
array(152) { [0]=> string(21) "코오롱생명과학" [1]=> string(12) "일동제약" [2]=> string(18) "카이노스메드" [3]=> string(18) "한창바이오텍" [4]=> string(19) "JW중외제약2우B" [5]=> string(9) "팜스빌" [6]=> string(9) "비피도" [7]=> string(12) "노바렉스" [8]=> string(17) "JW중외제약우" [9]=> string(19) "에이프로젠 H&G" [10]=> string(15) "이수앱지스" [11]=> string(15) "에스텍파마" [12]=> string(15) "대성미생물" [13]=> string(15) "티움바이오" ...(생략) }
```

덧붙이자면 보통 인코딩 방식으로 UTF-8을 사용하지만 어떤 인코딩을 사용했는지는 Visual Studio Code 우측 하단에 적힌 인코딩 방식을 참고하여 알아낼 수 있습니다.

## 마무리

html에서 무심코 지나쳤던 `<meta charset="UTF-8">` 태그의 중요성을 깨달은 시간이었습니다. 사실 위 문제를 해결할 때 한 줄의 코드만을 추가하여 쉽게 해결했지만 이론적으로 공부해보니까 인코딩이 생각보다 간단하지 않은 문제라는 것을 알게 되었습니다. 또한 ASCII, 유니코드, 인코딩 변환 방식들에 얽힌 역사까지 공부할 수 있어서 매우 흥미로웠습니다. 처음 마주한 인코딩 문제는 생각보다 당황스러웠지만 다시 마주하게 된다면 잘 해결할 수 있을 것 같습니다.
